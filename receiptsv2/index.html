<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Capture Receipts</title>
<style>
  :root { --gap: 14px; --radius: 14px; --shadow: 0 6px 24px rgba(0,0,0,.08); }
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body {
    margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: #f5f5f7; color: #222;
    min-height: 100svh; display: flex; flex-direction: column; align-items: stretch;
  }
  .wrap { flex: 1 0 auto; display: grid; place-items: start center; padding: var(--gap); }
  .container {
    width: 100%; max-width: 640px; background: #fff; border-radius: var(--radius);
    padding: calc(var(--gap) * 1.2); box-shadow: var(--shadow);
  }
  h1 { font-size: 22px; margin: 0 0 10px; display: flex; align-items: center; gap: 8px; }
  .muted { color: #666; font-size: 14px; margin-bottom: 12px; }
  .btn {
    width: 100%; padding: 16px; font-size: 18px; border: none; border-radius: 10px;
    cursor: pointer; font-weight: 600;
  }
  .btn-primary { background: #1976d2; color: #fff; }
  .btn-primary:active { background: #155fb1; }
  .btn-add    { background: #2e7d32; color: #fff; }
  .btn-add:active { background: #296e2c; }
  .btn:disabled { opacity: .6; cursor: not-allowed; }
  .form-group { margin: 14px 0; }
  label { display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 15px; }
  input[type="text"], input[type="date"], textarea {
    width: 100%; padding: 12px 14px; font-size: 16px; border: 1px solid #ddd; border-radius: 10px; background: #fff;
  }
  textarea { min-height: 96px; resize: vertical; }
  input:focus, textarea:focus { outline: none; border-color: #1976d2; box-shadow: 0 0 0 3px rgba(25,118,210,.12); }
  .preview-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 12px 0; }
  .preview-item { position: relative; aspect-ratio: 1; }
  .preview-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; image-orientation: from-image; }
  .preview-item .remove {
    position: absolute; top: -8px; right: -8px; width: 26px; height: 26px;
    background: #e53935; color: white; border: none; border-radius: 50%; font-size: 18px; line-height: 1; cursor: pointer;
  }
  .status { padding: 12px; border-radius: 10px; margin-top: 10px; font-weight: 600; text-align: center; }
  .status.success { background: #e8f5e9; color: #2e7d32; }
  .status.error   { background: #ffebee; color: #c62828; }
  .status.info    { background: #e3f2fd; color: #1565c0; }
  .log { background: #fafafa; border: 1px solid #eee; border-radius: 10px; padding: 10px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; max-height: 160px; overflow-y: auto; white-space: pre-wrap; word-break: break-word; }
  .photo-badge { background: #1976d2; color: #fff; padding: 2px 8px; border-radius: 12px; font-size: 13px; margin-left: 8px; }

  .actionbar { position: sticky; bottom: 0; background: #fff; padding-top: 12px; margin-top: 8px; }

  @media (max-width: 520px) {
    .container { padding: 14px; border-radius: 12px; }
    .preview-grid { grid-template-columns: repeat(3, 1fr); }
  }
</style>

<!-- Endpoint guards: look for GAS_ID, then #exec / ?exec, then localStorage. If missing, show setup screen. -->
<script>
  // Build from candidate value (ID or full URL)
  function buildEndpoint(raw){
    if (!raw) return '';
    return raw.startsWith('http')
      ? raw.replace(/\/dev(?:\b|$)/, '/exec')
      : `https://script.google.com/macros/s/${raw}/exec`;
  }
  function getExecFromUrl(){
    const h = new URLSearchParams(location.hash.slice(1));
    const q = new URLSearchParams(location.search);
    return h.get('exec') || q.get('exec') || '';
  }

  // Priority: global GAS_ID (if defined) â†’ URL (#exec or ?exec) â†’ localStorage
  const RAW_EXEC =
    (typeof GAS_ID !== 'undefined' && GAS_ID) ? GAS_ID :
    getExecFromUrl() || localStorage.getItem('receipt_exec') || '';

  const WEBAPP_URL = buildEndpoint(RAW_EXEC);
  window.WEBAPP_URL = WEBAPP_URL; // expose for the app

  if (!WEBAPP_URL) {
    // Replace document with a setup screen; user can paste an exec ID or full /exec URL
    document.documentElement.innerHTML = `
      <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Receipt Capture â€“ Setup</title>
        <style>
          body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#f5f5f7;margin:0;min-height:100svh;display:grid;place-items:center}
          .wrap{width:min(720px,92vw);background:#fff;padding:24px 20px;border-radius:14px;box-shadow:0 6px 24px rgba(0,0,0,.08)}
          h1{margin:0 0 10px;font-size:22px}
          p{color:#555;margin:8px 0}
          input{width:100%;padding:12px 14px;border:1px solid #ddd;border-radius:10px;font-size:16px}
          .row{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
          button{padding:12px 16px;border:0;border-radius:10px;background:#1976d2;color:#fff;font-weight:700;cursor:pointer}
          button.secondary{background:#6b7280}
          code{background:#f1f3f5;padding:2px 6px;border-radius:6px}
        </style>
      </head>
      <body>
        <div class="wrap">
          <h1>Set up endpoint</h1>
          <p>This page needs your Apps Script web-app endpoint (exec ID or full <code>/exec</code> URL).</p>
          <p>Fastest way: bookmark with <code>#exec=YOUR_EXEC_ID</code>, e.g. <code>${location.origin + location.pathname}#exec=abc123</code></p>
          <input id="execInput" placeholder="Paste exec ID or full /exec URL">
          <div class="row">
            <button onclick="(function(){
              const v = document.getElementById('execInput').value.trim();
              if(!v){alert('Please paste an exec ID or URL');return;}
              localStorage.setItem('receipt_exec', v);
              const isUrl = /^https?:/i.test(v);
              const id = isUrl ? v.split('/').filter(Boolean).slice(-2,-1)[0] : v;
              location.hash = '#exec=' + encodeURIComponent(id);
              location.reload();
            })()">Save & Reload</button>
            <button class="secondary" onclick="(function(){
              localStorage.removeItem('receipt_exec');
              location.href = location.pathname; // drop params/fragments
            })()">Clear</button>
          </div>
        </div>
      </body>`;
  }
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-/Vwzv+N2zW2mC3z4nE6h0B4mY9yXxDkQ5q2wK3oJr8G8eC4gGg7w2p8zv7zFf3X5p8f1nQx4xQkq9tR1JmC6GQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>

<div class="wrap" id="app" style="display:none">
  <div class="container">
    <h1>ðŸ“¸ Receipt Capture</h1>
    <p class="muted">Create a PDF from photos and upload to Drive.</p>

    <input id="filePicker" type="file" accept="image/*;capture=camera" capture="environment" multiple hidden>

    <button id="addBtn" class="btn btn-add">
      ðŸ“· Add Photos
      <span class="photo-badge" id="photoBadge" style="display:none">0</span>
    </button>

    <div class="form-group">
      <label for="description">Description *</label>
      <textarea id="description" placeholder="Enter receipt description..." required></textarea>
    </div>

    <div class="form-group">
      <label for="date">Date</label>
      <input type="date" id="date">
    </div>

    <div class="preview-grid" id="previewGrid"></div>

    <div class="actionbar">
      <button id="submitBtn" class="btn btn-primary">Submit Receipt</button>
      <div id="statusDiv" class="status" style="display:none"></div>
    </div>

    <details id="logDetails" style="margin-top:10px; display:none">
      <summary style="cursor:pointer; padding:8px 0; color:#666;">View Log</summary>
      <div class="log" id="logDiv"></div>
    </details>
  </div>
</div>

<script>
(function init(){
  if (!window.WEBAPP_URL) return; // setup screen already shown
  document.getElementById('app').style.display = '';

  const { jsPDF } = window.jspdf;

  // Elements
  const filePicker   = document.getElementById('filePicker');
  const addBtn       = document.getElementById('addBtn');
  const previewGrid  = document.getElementById('previewGrid');
  const description  = document.getElementById('description');
  const dateInput    = document.getElementById('date');
  const submitBtn    = document.getElementById('submitBtn');
  const statusDiv    = document.getElementById('statusDiv');
  const logDiv       = document.getElementById('logDiv');
  const logDetails   = document.getElementById('logDetails');
  const photoBadge   = document.getElementById('photoBadge');

  // State
  let photos = [];

  // Todayâ€™s date
  dateInput.value = new Date().toISOString().split('T')[0];

  // Events
  addBtn.addEventListener('click', () => filePicker.click());
  filePicker.addEventListener('change', (e) => {
    const files = Array.from(e.target.files || []);
    files.forEach(file => {
      photos.push(file);
      addPreviewItem(file, photos.length - 1);
      log(`Added: ${file.name} (${Math.round(file.size/1024)} KB)`);
    });
    updatePhotoBadge();
    filePicker.value = '';
  });
  submitBtn.addEventListener('click', handleSubmit);

  // UI helpers
  function addPreviewItem(file, index) {
    const item = document.createElement('div');
    item.className = 'preview-item';
    item.dataset.index = index;

    const img = document.createElement('img');
    img.src = URL.createObjectURL(file);

    const removeBtn = document.createElement('button');
    removeBtn.className = 'remove';
    removeBtn.textContent = 'Ã—';
    removeBtn.onclick = () => removePhoto(index);

    item.appendChild(img);
    item.appendChild(removeBtn);
    previewGrid.appendChild(item);
  }
  function removePhoto(index) {
    photos.splice(index, 1);
    rebuildPreviews();
    updatePhotoBadge();
    log(`Removed photo ${index + 1}`);
  }
  function rebuildPreviews() {
    previewGrid.innerHTML = '';
    photos.forEach((p, i) => addPreviewItem(p, i));
  }
  function updatePhotoBadge() {
    if (photos.length > 0) {
      photoBadge.textContent = photos.length;
      photoBadge.style.display = '';
    } else {
      photoBadge.style.display = 'none';
    }
  }
  function showStatus(message, type) {
    statusDiv.textContent = message;
    statusDiv.className = `status ${type || 'info'}`;
    statusDiv.style.display = '';
    if (type && type !== 'info') setTimeout(() => statusDiv.style.display = 'none', 5000);
  }
  function log(message) {
    const time = new Date().toLocaleTimeString();
    logDiv.textContent += `[${time}] ${message}\n`;
    logDiv.scrollTop = logDiv.scrollHeight;
    logDetails.style.display = '';
  }
  function startAlive(label) {
    let dots = 0;
    submitBtn.disabled = true;
    const base = label || 'Working';
    submitBtn.textContent = base;
    const id = setInterval(() => {
      dots = (dots + 1) % 4;
      submitBtn.textContent = base + '.'.repeat(dots);
    }, 450);
    return () => { clearInterval(id); submitBtn.disabled = false; submitBtn.textContent = 'Submit Receipt'; };
  }

  // Main
  async function handleSubmit() {
    if (photos.length === 0) {
      showStatus('Please add at least one photo', 'error');
      return;
    }
    if (!description.value.trim()) {
      showStatus('Description is required', 'error');
      description.focus();
      return;
    }

    const stopAlive = startAlive('Uploading');

    try {
      log('Building PDFâ€¦');
      showStatus('Building PDFâ€¦', 'info');

      const pdf = new jsPDF();
      for (let i = 0; i < photos.length; i++) {
        log(`Processing image ${i + 1}/${photos.length}`);
        showStatus(`Processing image ${i + 1} of ${photos.length}â€¦`, 'info');

        const dataUrl = await resizeImage(photos[i]);
        const img = await loadImage(dataUrl);

        const pageW = pdf.internal.pageSize.getWidth();
        const pageH = pdf.internal.pageSize.getHeight();
        const scale = Math.min(pageW / img.width, pageH / img.height);
        const w = img.width * scale, h = img.height * scale;
        const x = (pageW - w) / 2, y = (pageH - h) / 2;

        if (i > 0) pdf.addPage();
        pdf.addImage(dataUrl, 'JPEG', x, y, w, h);
      }

      log('Uploading to Driveâ€¦');
      showStatus('Uploading to Driveâ€¦', 'info');

      const payload = {
        description: description.value.trim(),
        date: dateInput.value,
        pdf_base64: pdf.output('datauristring').split(',')[1]
      };

      const res = await fetch(window.WEBAPP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' }, // simple request, no preflight
        body: JSON.stringify(payload),
      });

      if (res.type === 'opaque') {
        showStatus('Upload sent, but response blocked by CORS. Ensure your Apps Script web app is â€œExecute as Meâ€ and â€œAnyone with the linkâ€, and that you are using the /exec URL.', 'error');
        log('CORS: opaque response â€“ check deployment visibility and use the /exec URL.');
        return;
      }

      const raw = await res.text();
      let data = null;
      try { data = JSON.parse(raw); } catch { /* ignore */ }

      if (!res.ok || !data || data.ok === false) {
        const msg = data && data.error ? `${data.error.code || 'ERROR'}: ${data.error.message}` : (raw || `HTTP ${res.status}`);
        showStatus('âŒ ' + msg, 'error');
        log('Server error: ' + (data ? JSON.stringify(data) : raw));
        return;
      }

      showStatus(`âœ… Success! Receipt ID: ${data.receipt_id}`, 'success');
      log(`Success: receipt_id=${data.receipt_id}, fileId=${data.fileId}, elapsed_ms=${data.elapsed_ms}`);

      // Reset
      photos = [];
      rebuildPreviews();
      description.value = '';
      dateInput.value = new Date().toISOString().split('T')[0];
      updatePhotoBadge();

    } catch (err) {
      showStatus('âŒ Upload failed', 'error');
      log(`Error: ${err.message}`);
    } finally {
      stopAlive();
    }
  }

  // Helpers
  function loadImage(src) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = reject;
      img.src = src;
    });
  }
  function resizeImage(file) {
    // Simple client compression, preserves aspect, max side ~1080px
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const max = 1080;
          let { width, height } = img;
          if (width > height && width > max) { height = (max / width) * height; width = max; }
          else if (height > max)             { width  = (max / height) * width; height = max; }

          const canvas = document.createElement('canvas');
          canvas.width = Math.round(width); canvas.height = Math.round(height);
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          resolve(canvas.toDataURL('image/jpeg', 0.8));
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });
  }
})();
</script>

</body>
</html>
