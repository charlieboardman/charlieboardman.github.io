<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cameraâ€‘toâ€‘PDF Uploader</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:sans-serif;margin:1rem;line-height:1.4}
    video,canvas{max-width:100%;border:1px solid #ccc;border-radius:6px}
    #thumbs img{width:5rem;margin:.25rem;border:1px solid #999;border-radius:4px}
    button{margin:.5rem .25rem;padding:.6rem 1rem;font-size:.95rem}
    #log{white-space:pre-wrap;font-size:.85rem;margin-top:.5rem}
  </style>
</head>
<body>
  <h2>Scan multiâ€‘page PDF &amp; upload</h2>

  <!-- live camera feed -->
  <video id="vid" playsinline autoplay></video><br>

  <!-- action buttons -->
  <button id="snapBtn">ðŸ“¸Â CaptureÂ page</button>
  <button id="sendBtn" disabled>ðŸ“¤Â FinishÂ &Â Upload</button>
  <span id="count">0Â page(s)</span>

  <!-- thumbnails -->
  <div id="thumbs"></div>

  <div id="log"></div>

  <!-- pdfâ€‘lib -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script>
    (async () => {
      /* ************  adjust this  ************ */
      const POST_URL = 'https://example.com/receive';
      /* **************************************** */

      const vid   = document.getElementById('vid');
      const snap  = document.getElementById('snapBtn');
      const send  = document.getElementById('sendBtn');
      const count = document.getElementById('count');
      const thumbs= document.getElementById('thumbs');
      const logEl = document.getElementById('log');

      let stream, trackSettings;
      let pages = [];        // Array<Uint8Array> (JPEG bytes)

      const log = t => (logEl.textContent += t + '\n');

      /* ---- start camera ---- */
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: {facingMode: 'environment'}
        });
        vid.srcObject = stream;
        trackSettings = stream.getVideoTracks()[0].getSettings();
      } catch (e) {
        alert('Camera access failed: ' + e.message);
        return;
      }

      /* ---- capture still frame ---- */
      snap.onclick = async () => {
        const {width:w, height:h} = trackSettings;
        const canvas = Object.assign(document.createElement('canvas'), {width:w, height:h});
        canvas.getContext('2d').drawImage(vid, 0, 0, w, h);
        const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.85));
        const bytes = new Uint8Array(await blob.arrayBuffer());
        pages.push(bytes);

        // thumb UI
        const img = new Image();
        img.src = URL.createObjectURL(blob);
        thumbs.appendChild(img);

        count.textContent = pages.length + ' page(s)';
        send.disabled = false;
      };

      /* ---- build PDF & upload ---- */
      send.onclick = async () => {
        send.disabled = true;
        try {
          log('Building PDF â€¦');
          const pdfBytes = await buildPdf(pages);
          log(`PDF size: ${(pdfBytes.length/1024).toFixed(1)}Â kB`);

          log('Baseâ€‘64 encoding â€¦');
          const b64 = uint8ToBase64(pdfBytes);

          log('POSTing â€¦');
          const res = await fetch(POST_URL, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({pdfBase64: b64})
          });
          log('Server replied ' + res.status);
        } catch (e) {
          log('Error: ' + e.message);
        } finally {
          send.disabled = false;
        }
      };

      /* ---------- helpers ---------- */

      async function buildPdf(jpegPages){
        const pdf = await PDFLib.PDFDocument.create();
        for (const bytes of jpegPages){
          const img  = await pdf.embedJpg(bytes);
          const page = pdf.addPage([img.width,img.height]);
          page.drawImage(img,{x:0,y:0,width:img.width,height:img.height});
        }
        return await pdf.save();  // Uint8Array
      }

      function uint8ToBase64(u8){
        let bin=''; for(let i=0;i<u8.length;i++) bin+=String.fromCharCode(u8[i]);
        return btoa(bin);
      }
    })();
  </script>
</body>
</html>
