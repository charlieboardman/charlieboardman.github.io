<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>CFDI (ZIP of XML) → XLSX</title>
	<style>
		body {
			font-family: system-ui, sans-serif;
			margin: 2rem;
			max-width: 900px;
		}
		h1 {
			margin-top: 0;
		}
		.row {
			display: flex;
			gap: 1rem;
			align-items: center;
			flex-wrap: wrap;
		}
		#log {
			white-space: pre-wrap;
			background: #f6f6f6;
			padding: 1rem;
			border-radius: 8px;
			max-height: 40vh;
			overflow: auto;
		}
		button {
			padding: 0.6rem 1rem;
		}
		.muted {
			color: #666;
		}
		progress {
			width: 100%;
			height: 12px;
		}
	</style>
</head>
<body>
	<h1>CFDI ZIP → XLSX Converter (client-side)</h1>
	<p class="muted">
		Drop or select one or more <strong>.zip</strong> files (each containing
		CFDI XMLs). Nothing leaves your browser.
	</p>

	<div class="row">
		<input id="fileInput" type="file" accept=".zip" multiple />
		<button id="convertBtn">Convert to XLSX</button>
	</div>

	<p class="muted">Progress</p>
	<progress id="prog" max="100" value="0"></progress>

	<h3>Log</h3>
	<div id="log"></div>

	<!-- We'll add our JavaScript dependencies and code here step by step -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script>
        const fileInput = document.getElementById('fileInput') //Get the file input element
        const convertBtn = document.getElementById('convertBtn') //Get the convert button
        const logDiv = document.getElementById('log') //Get the log area of the page
		const allFacturas = [] //This will hold the rows which are then written to the spreadsheet file

        function log(message) {
            logDiv.textContent += message+ '\n'           
        }

		convertBtn.addEventListener('click', function() { //When the convert button is pressed
			const zipFiles = fileInput.files //Grab the zip files that were inserted into the input box
			log(`Selected ${zipFiles.length} files`)

			for (let i = 0; i < zipFiles.length; i++) { //Loop through the zip files
				const file = zipFiles[i]
				log(`Zip file ${i + 1}: ${file.name}`)

				log(`Reading ${file.name}...`)
				JSZip.loadAsync(file).then(function(zip) {
					log(`ZIP loaded! It contains ${Object.keys(zip.files).length} files`)
					for (let cfdi_n = 0; cfdi_n < (Object.keys(zip.files).length); cfdi_n++) {	//Loop through each XML file inside the zip file
						const fileName = Object.keys(zip.files)[cfdi_n]
						log(`	Processing: ${fileName}`)

						const zipEntry = zip.files[fileName]
						zipEntry.async('text').then(function(xmlContent) {
							log(`		Got XML content, length: ${xmlContent.length} characters`)

							// Parse XML string into DOM
							const parser = new DOMParser()
							const xmlDoc = parser.parseFromString(xmlContent, 'application/xml')
							
							const parseError = xmlDoc.querySelector('parsererror')
							if (parseError) {
								log(` XML PARSE ERROR: ${parseError.textContent}`)
								return
							}
							
							log(`		Parsed XML document, root element: ${xmlDoc.documentElement.tagName}`)
							
							var root = xmlDoc.documentElement
							window.debugRoot = root //Remove this for prod
							log(` Set window.debugRoot - check console now!`)

							log(` Root attributes: ${root.attributes.length}`)
    						log(` TipoDeComprobante: "${root.getAttribute('TipoDeComprobante')}"`)
							
							//We only want to log transactions that are actual payments, so tipo_comprobante = I
							//If it's P, skip it
							if (root.getAttribute('TipoDeComprobante') == 'P') {
								return
							}

							var folio = root.getAttribute('Folio')
							var fecha = root.getAttribute('Fecha').split('T')[0]
							var hora = root.getAttribute('Fecha').split('T')[1]

						})

					}
				})
			}			
			
		});
	</script>

</body>
</html>

